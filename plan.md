# План разработки BusMaps Telegram Mini App

## Обзор проекта

**BusMaps** - Telegram Mini App для построения маршрутов с использованием Leaflet карт. Приложение работает полностью на клиентской стороне, использует бесплатные API для построения маршрутов и хранит пользовательские данные в Telegram Cloud Storage.

## Цели проекта

### Этап 1: MVP - Пешие маршруты (Текущий этап)
- ✅ Настройка проекта и структуры
- ⏳ Базовый интерфейс с картой Leaflet
- ⏳ Выбор начальной и конечной точки на карте
- ⏳ Построение пешего маршрута через OSRM API
- ⏳ Отображение маршрута на карте
- ⏳ Информация о расстоянии и времени маршрута
- ⏳ Интеграция с Telegram WebApp API

### Этап 2: Расширенные функции пеших маршрутов
- Поиск адресов и точек интереса
- Сохранение избранных маршрутов в Telegram Cloud
- История маршрутов
- Настройки маршрутизации (избегать лестниц, парков и т.д.)
- Экспорт маршрута в текстовый формат

### Этап 3: Маршруты общественного транспорта
- Интеграция с OpenTripPlanner или аналогичными сервисами
- Поиск маршрутов на автобусах/троллейбусах
- Отображение остановок на карте
- Расписание транспорта
- Уведомления о прибытии транспорта (через Telegram)

### Этап 4: Продвинутые функции
- Комбинированные маршруты (пешком + транспорт)
- Оптимизация маршрутов по времени/стоимости
- Реальное время движения транспорта (если доступно API)
- Офлайн режим (кеширование карт)
- Поделиться маршрутом с другими пользователями

## Технический стек

### Frontend
- **React 18** + **TypeScript** - основной фреймворк
- **Vite** - сборщик и dev-сервер
- **Leaflet** + **React-Leaflet** - карты
- **@twa-dev/sdk** - интеграция с Telegram
- **Axios** - HTTP запросы к API

### API и сервисы
- **OpenStreetMap** - карты (через Leaflet)
- **OSRM** - построение пеших маршрутов
  - Публичный сервер: `https://router.project-osrm.org/route/v1`
  - Альтернатива: собственный сервер OSRM
- **Nominatim** - геокодирование (поиск адресов)
  - API: `https://nominatim.openstreetmap.org/`
- **OpenTripPlanner** (для этапа 3) - планирование маршрутов транспорта
- **GTFS данные** (для этапа 3) - расписания транспорта

### Хранение данных
- **Telegram Cloud Storage** - пользовательские данные через `window.Telegram.WebApp.CloudStorage`
- Локальное хранилище браузера для кеша

## Структура проекта

```
busmaps-tg/
├── src/
│   ├── components/          # React компоненты
│   │   ├── Map/            # Компонент карты
│   │   ├── RoutePlanner/   # Планировщик маршрутов
│   │   ├── RouteInfo/      # Информация о маршруте
│   │   └── SearchBar/      # Поиск адресов
│   ├── hooks/              # Custom React hooks
│   │   ├── useTelegram.ts  # Работа с Telegram API
│   │   ├── useRouting.ts   # Логика маршрутизации
│   │   └── useMap.ts       # Управление картой
│   ├── services/           # Сервисы для работы с API
│   │   ├── osrm.ts         # OSRM API клиент
│   │   ├── nominatim.ts    # Геокодирование
│   │   └── telegram.ts     # Telegram Cloud Storage
│   ├── types/              # TypeScript типы
│   │   ├── route.ts
│   │   ├── map.ts
│   │   └── telegram.ts
│   ├── utils/              # Утилиты
│   │   ├── format.ts       # Форматирование данных
│   │   └── storage.ts      # Работа с хранилищем
│   ├── App.tsx             # Главный компонент
│   ├── main.tsx            # Точка входа
│   └── index.css           # Глобальные стили
├── public/                 # Статические файлы
├── package.json
├── tsconfig.json
├── vite.config.ts
├── plan.md                 # Этот файл
└── agents.md               # Документация для AI агентов
```

## Этап 1: Детальный план MVP

### Задача 1.1: Настройка карты Leaflet
- [x] Установка зависимостей
- [ ] Создание компонента Map
- [ ] Настройка базовой карты с OpenStreetMap тайлами
- [ ] Адаптация под мобильные устройства
- [ ] Обработка жестов (zoom, pan)

### Задача 1.2: Выбор точек на карте
- [ ] Добавление маркеров на карту
- [ ] Обработка клика/тапа для выбора точки
- [ ] Визуальная индикация выбранных точек
- [ ] Возможность удаления/изменения точки

### Задача 1.3: Интеграция с OSRM API
- [ ] Создание сервиса для работы с OSRM
- [ ] Функция построения маршрута между точками
- [ ] Обработка ошибок API
- [ ] Кеширование маршрутов

### Задача 1.4: Отображение маршрута
- [ ] Отрисовка маршрута на карте (polyline)
- [ ] Отображение информации о маршруте (расстояние, время)
- [ ] Адаптация карты под маршрут (fitBounds)
- [ ] Индикация загрузки

### Задача 1.5: Интеграция с Telegram
- [ ] Инициализация Telegram WebApp SDK
- [ ] Получение данных пользователя
- [ ] Настройка темы (светлая/темная)
- [ ] Обработка кнопок Telegram

### Задача 1.6: UI/UX
- [ ] Адаптивный дизайн для мобильных устройств
- [ ] Стилизация под Telegram дизайн
- [ ] Анимации и переходы
- [ ] Обработка состояний загрузки и ошибок

## Этап 2: Расширенные функции

### Поиск адресов
- Интеграция с Nominatim API
- Автодополнение при вводе
- Отображение результатов поиска
- Выбор адреса из результатов

### Сохранение маршрутов
- Сохранение в Telegram Cloud Storage
- Список сохраненных маршрутов
- Удаление маршрутов
- Редактирование названий

### История маршрутов
- Автоматическое сохранение последних маршрутов
- Быстрый доступ к истории
- Очистка истории

## Этап 3: Общественный транспорт

### Интеграция с OpenTripPlanner
- Настройка OTP сервера (или использование публичного)
- Построение маршрутов на транспорте
- Отображение остановок
- Информация о пересадках

### Расписание транспорта
- Получение расписания для остановок
- Отображение времени прибытия
- Фильтрация по типу транспорта

## Этап 4: Продвинутые функции

### Комбинированные маршруты
- Логика комбинирования пеших и транспортных участков
- Оптимизация по времени/стоимости
- Визуализация всех участков маршрута

### Реальное время
- Интеграция с API реального времени (если доступно)
- Обновление информации о транспорте
- Уведомления через Telegram

## Метрики успеха

### MVP (Этап 1)
- ✅ Приложение запускается в Telegram
- ✅ Пользователь может выбрать две точки на карте
- ✅ Маршрут строится и отображается корректно
- ✅ Информация о маршруте отображается

### Этап 2
- Поиск адресов работает быстро и точно
- Пользователи могут сохранять маршруты
- История маршрутов доступна

### Этап 3
- Маршруты на транспорте строятся корректно
- Расписание отображается актуально
- Остановки видны на карте

## Ограничения и риски

### Технические ограничения
- Зависимость от внешних API (OSRM, Nominatim)
- Лимиты запросов к публичным API
- Размер приложения (Telegram Mini App ограничения)

### Риски
- Изменение API внешних сервисов
- Блокировка доступа к API
- Производительность на слабых устройствах

### Решения
- Кеширование запросов
- Fallback на альтернативные API
- Оптимизация производительности
- Возможность использования собственного OSRM сервера

## Временные рамки

- **Этап 1 (MVP)**: 2-3 недели
- **Этап 2**: 2 недели
- **Этап 3**: 3-4 недели
- **Этап 4**: 4+ недели (по мере необходимости)

## Ресурсы

### Документация
- [Leaflet Documentation](https://leafletjs.com/)
- [React-Leaflet](https://react-leaflet.js.org/)
- [Telegram Mini Apps](https://core.telegram.org/bots/webapps)
- [OSRM API](http://project-osrm.org/docs/v5.24.0/api/)
- [Nominatim API](https://nominatim.org/release-docs/develop/api/Overview/)

### Полезные ссылки
- [Telegram WebApp SDK](https://github.com/twa-dev/sdk)
- [OpenStreetMap](https://www.openstreetmap.org/)
- [OpenTripPlanner](https://www.opentripplanner.org/)
